name: ä¸Šæ¸¸åŒæ­¥ | Upstream Sync

permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write

on:
  # é»˜è®¤å…³é—­è‡ªåŠ¨åŒæ­¥ï¼Œä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
  # schedule:
  #   - cron: '0 */6 * * *' # every 6 hours
  workflow_dispatch:
    inputs:
      add_comment:
        description: 'æ˜¯å¦åœ¨åŒæ­¥åæ·»åŠ è¯„è®º | Add comment after sync'
        required: false
        default: true
        type: boolean

jobs:
  sync_latest_from_upstream:
    name: åŒæ­¥ä¸Šæ¸¸æœ€æ–°æäº¤ | Sync latest commits from upstream repo
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - uses: actions/checkout@v4

      - name: æ¸…ç†å¤±è´¥é€šçŸ¥ | Clean issue notice
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issues'
          labels: 'ğŸš¨ Sync Fail'

      - name: åŒæ­¥ä¸Šæ¸¸å˜æ›´ | Sync upstream changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: oiov/wr.do
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }} # automatically generated, no need to set
          test_mode: false

      - name: è·å–æœ€æ–°æäº¤ä¿¡æ¯ | Get latest commit info
        if: success()
        id: commit_info
        run: |
          # è·å–æœ€æ–°çš„ commit SHA å’Œä¿¡æ¯
          LATEST_COMMIT=$(git rev-parse HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          SYNC_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "sync_time=$SYNC_TIME" >> $GITHUB_OUTPUT

      - name: æ·»åŠ åŒæ­¥è¯„è®º | Add sync comment to commit
        if: success() && github.event.inputs.add_comment == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = '${{ steps.commit_info.outputs.latest_commit }}';
            const syncTime = '${{ steps.commit_info.outputs.sync_time }}';
            const commitMsg = '${{ steps.commit_info.outputs.commit_message }}';
            const commitAuthor = '${{ steps.commit_info.outputs.commit_author }}';

            const commentBody = `## ğŸ”„ åŒæ­¥æˆåŠŸ | Sync Successful

            **åŒæ­¥æ—¶é—´ | Sync Time:** ${syncTime}
            **æºä»“åº“ | Source Repository:** [oiov/wr.do](https://github.com/oiov/wr.do)
            **åŒæ­¥åˆ†æ”¯ | Sync Branch:** main â†’ main
            **æœ€æ–°æäº¤ | Latest Commit:** ${commitMsg}
            **æäº¤ä½œè€… | Commit Author:** ${commitAuthor}

            ---
            *æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | This comment was automatically generated by GitHub Actions*`;

            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commitSha,
                body: commentBody
              });
              console.log('âœ… æˆåŠŸæ·»åŠ åŒæ­¥è¯„è®ºåˆ° commit:', commitSha);
            } catch (error) {
              console.log('âŒ æ·»åŠ è¯„è®ºå¤±è´¥:', error.message);
            }

      - name: åŒæ­¥æ£€æŸ¥ | Sync check
        if: failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å¤±è´¥ | Sync Fail'
          labels: 'ğŸš¨ Sync Fail'
          body: |
            ## åŒæ­¥å¤±è´¥è¯¦æƒ… | Sync Failure Details

            **å¤±è´¥æ—¶é—´ | Failure Time:** ${{ steps.commit_info.outputs.sync_time || 'Unknown' }}
            **æºä»“åº“ | Source Repository:** [oiov/wr.do](https://github.com/oiov/wr.do)
            **ç›®æ ‡åˆ†æ”¯ | Target Branch:** main
            **å·¥ä½œæµè¿è¡Œ | Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### å¯èƒ½çš„åŸå›  | Possible Causes:
            - ä¸Šæ¸¸ä»“åº“çš„ workflow æ–‡ä»¶å‘ç”Ÿå˜æ›´
            - å­˜åœ¨åˆå¹¶å†²çª
            - ç½‘ç»œè¿æ¥é—®é¢˜
            - æƒé™ä¸è¶³

            ### è§£å†³æ–¹æ¡ˆ | Solutions:
            1. æ‰‹åŠ¨æ‰§è¡Œ Sync Fork æ“ä½œ
            2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆå¹¶å†²çª
            3. é‡æ–°è¿è¡Œæ­¤å·¥ä½œæµ

            ---
            Due to a change in the workflow file of the [oiov/wr.do](https://github.com/oiov/wr.do) upstream repository, GitHub has automatically suspended the scheduled automatic update. You need to manually sync your fork.

            ç”±äº [oiov/wr.do](https://github.com/oiov/wr.do) ä¸Šæ¸¸ä»“åº“çš„ workflow æ–‡ä»¶å˜æ›´ï¼Œå¯¼è‡´ GitHub è‡ªåŠ¨æš‚åœäº†æœ¬æ¬¡è‡ªåŠ¨æ›´æ–°ï¼Œä½ éœ€è¦æ‰‹åŠ¨ Sync Fork ä¸€æ¬¡ã€‚

